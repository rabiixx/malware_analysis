#!/bin/bash

if [ $# -eq 0 ]
  then
    echo "Sample path is required, not provided"
    exit -1
fi

if [ -z "$1" ]
  then
    echo "Sample path is required, not provided"
    exit -1
fi

sample_path=$1

# Create sample uuid
sample_uuid=$(uuid)
mkdir $sample_uuid

echo "Sample Path: $sample_path"
echo "Sample uuid: $sample_uuid"

# Unzip Sample
7z x $sample_path -pinfected -o${sample_uuid} >/dev/null

sample=$(ls $sample_uuid)

# Calculate sample hashes
sample_sha1=$(sha1sum ${sample_uuid}/${sample} | awk 'NR==1{print $1}')
sample_sha256=$(sha256sum ${sample_uuid}/${sample} | awk 'NR==1{print $1}')
sample_ssdeep=$(ssdeep ${sample_uuid}/${sample})

# Sample Directory
sample_dir=${sample_uuid}/${sample_sha1}
mkdir $sample_dir

echo -n $sample_sha1 > ${sample_dir}/${sample_sha1}.sha1
echo -n $sample_sha256 > ${sample_dir}/${sample_sha1}.sha256
echo -n $sample_ssdeep > ${sample_dir}/${sample_sha1}.ssdeep
echo -n "infected" > ${sample_dir}/${sample_sha1}.password

# Rename malware
mv ${sample_uuid}/${sample} ${sample_uuid}/${sample_sha1}.malware

# Zip malware
7z a -pinfected ${sample_dir}/${sample_sha1}.zip ${sample_uuid}/${sample_sha1}.malware >/dev/null

rm ${sample_uuid}/${sample_sha1}.malware